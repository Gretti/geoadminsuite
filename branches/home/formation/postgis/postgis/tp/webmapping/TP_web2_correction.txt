________________
TP Webmapping 2:
____
But: 

Afficher le MNT présent dans la base "tp" dans une carte OpenLayers
Permettre le dessin d'un ligne, puis realiser le profil altimetrique le long de cette
ligne en demandant a Postgis l'intersection de la ligne avec le MNT.
Afficher le profil dans un graphique a cote de la carte.
Utilisation de la lib js jqplot pour afficher le graphe.
(cf. TP Raster 3 (tp_r3_correction.txt);

Necessite un serveur d'application capable de lire les données depuis postgis et
de les envoyer vers un client (Navigateur, openLayers)

PHP sera utilisé comme langage coté serveur. Tout autre langage est possible:
Javascript server
Java
Python
Ruby
...

_______
Etapes:

1°) Vérifier que le mnt est présent dans la base "tp", l'y inserer sinon (tp_r3_correction.txt)

2°) Mettre en place une page web contenant une carte OpenLayers affchant le raster (cf. mapfile ci-dessous)
Utiliser une WMSLayer pour afficher le carte.
Ajouter les scripts JS jqplot et preparer un element html qui recevra le graphe
dessiné par jqplot:

    cf. TP_web2.html et TP_web2.map pour le mapfile affichant le raster

3°) Ecrire une page PHP se connectant a Postgis (driver PDO PGSQL) et réalisant l'intersection
de la ligne envoyée par le client web et du MNT.
Ecrire la requete pour retourner une structure compatible avec jqplot.

La requete utilise les deux requetes vues au tp raster 3 et genere directement
les points affichables dans jqplot:

with ln as (
    select st_setSRID('LINESTRING ( 150000 6950000, 330000 6950000, 160000 6890000, 270000 6860000, 270000 6810000, 360000 6810000, 330000 6760000, 380000 6730000 )'::geometry, 2154)
    as geom
), 
inter as (
-- intersection du raster avec la ligne
	SELECT ST_Intersection(ln.geom, mnt.rast) as gv 
    from mnt, ln where 
    ST_Intersects(ln.geom, mnt.rast)
), 
points as (
    SELECT st_setSRID(st_makePoint(st_X(st_startPoint((gv).geom)), st_Y(st_startPoint((gv).geom)), (gv).val), 2154) as geom, (gv).val 
    from inter

)
 select (st_line_locate_point(ln.geom, pt.geom) * st_length(ln.geom))/1000 as x, st_Z(pt.geom)  as z
from ln, points as pt
where ln.geom is not null and pt.geom is not null;

    cf. getprofile.php

_________
Conseils:

Demo JSON OpenLayers: http://openlayers.org/dev/examples/geojson.html
Demo Edition OpenLayers: http://openlayers.org/dev/examples/draw-feature.html
Connexion PHP / PG: http://php.net/manual/en/function.pg-connect.php

Mapfile pour afficher le raster dans OpenLayers:
________________________________________________________________________________
map
    name "demomap"

    # la taille est la meme que celle de la carte affichée dans la page web
    # (style middlemap défini dans le fichier de style styles.css
    size 670 430

    imagetype png

    # extension spatiale du raster, obtenu avec la requete postgis:
    #select extent::box2d from raster_columns where r_table_name='mnt';
    extent 70645 6433104 489673 7018161

    # projection: requis par le protocole WMS
    projection
        "init=epsg:2154"
    end
    
    #MEtadonnées necessaires pour activer le protocole WMS server
    WEB
        metadata
            "wms_title"           "WMS Demo Server"
            "wms_onlineresource"  "http://localhost/cgi-bin/mapserv?map=/Users/nicolas/Projets/Formation/kits/postgis/tp/webmapping/TP_web2.map&"
            "wms_srs"             "EPSG:2154"
            "wms_enable_request"  "*"
        end
    END

    layer
        name "mnt"
        metadata
            "wms_title"           "mnt"
        end

        projection
            "init=epsg:2154"
        end

        type raster
        # dans le mapfile, les mots cles peuvent etre en minuscules ou majiscules
        STATUS default
        DATA "PG:host=localhost port=5432 dbname='tp' user='nicolas' table='mnt' mode='2'"	
        #DATA "/tmp/srtm_36_03_2154.tif"
        #PROCESSING "NODATA=0"
        CLASS 
           STYLE 
              COLORRANGE 0 0 255 255 20 20 
              DATARANGE -90 430  
           END 
        END     
    end
end
________________________________________________________________________________


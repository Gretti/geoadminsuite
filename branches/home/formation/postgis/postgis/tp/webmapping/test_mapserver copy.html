<!-- 
 Le but de cette page HTML est d'appeler le programme MapServer en lui précisant
 quel mapfile utiliser, et d'afficher l'image renvoyée par MapServer.
 
 Un formulaire simple permet de piloter l'URL de Mapserver pour illustrer la possibilité
 de surcharger les elements du mapfile.
 
 Pour plus de souplesse, l'URL de l'image affichée est pilotée par du script Javascript.
 Cela illustre aussi la souplesse d'utilisation de Mapserver dans un contexte de page
 HTML simple (sans framework client).
 
 Un framework Javascript type JQuery ou ExtJS donnerait bcp plus de
 souplesse et de puissance a cette page.
-->
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script type="text/javascript">
        
        //<!-- des variables  nécessaires au test -->
        
        // A CHANGER EN FONCTION DE L'INSTALLATION LOCALE 
        // l'URL Mapserver, générée dynamiquement.
        var ms_url = "/cgi-bin/mapserv?map=/Users/nicolas/Projets/Formation/kits/postgis/tp/test_mapserver.map";
        
        // A CHANGER en fonction de l'extent defini dans le mapfile
        var mapext = "3427433 5789186 3443808 5800377"
        
        // A changer en fonctin de la taille de l'image définie dans le mapfile
        var mapsize = "600 400";
        
        //var ext = null;
        
        
        // la fonction permettant de soumettre le formulaire et/ou de piloter quelle
        // URL mapserver est envoyée a MS, et quel composant recoit la reponse (ici
        // une image)
        function refreshMap() {
            // masquage du div d'erreur
            document.getElementById("hid_div").style.visibility="hidden";
            
            // construction de l'URL MapServer (ajout de la date pour generer des URL uniques)
            var url = ms_url + "&mode=map" + "&u=" + (new Date());
            // ajout des parametres de surcharge présents dans la textarea:
            url += "&" + document.ms_form.ms_commands.value.trim();
            
            // La source de l'image ms_image devient cette URL => l'image affiche
            // ce qui est produit par MapServer
            document.images["ms_image"].src = url;
            
            // affichage de l'URL courante:
            document.getElementById("ms_url_div").innerHTML=url;
        }
        
        // fonction gérant d'eventuelles erreurs sur le chargement de l'image, donc
        // erreurs issues de MapServer:
        function imgError() {
            document.ms_form.ms_erreur.value = "Erreur Mapserver, vérifier le mapfile et/ou l'URL MS:\n" + ms_url;
            document.getElementById("ms_frame").src=ms_url;
            document.getElementById("hid_div").style.visibility="visible";
        }
        
        // fonction gérant le click sur la carte:
        function clickImg(event) {
            pos_x = event.offsetX?(event.offsetX):event.pageX-document.getElementById("ms_image").offsetLeft;
            pos_y = event.offsetY?(event.offsetY):event.pageY-document.getElementById("ms_image").offsetTop;
            window.status = "clicked at: " + pos_x + " " + pos_y;
            
            // genere la partie de l'URL MS permettant de changer le zoom
            zoomin = document.ms_form.zoomin.checked;
            
            mapext = computeExtent(zoomin, pos_x, pos_y);
            
            var url = ms_url + "&mode=map&mapext=" + mapext + "&u=" + (new Date());
            document.images["ms_image"].src = url;
            // affichage de l'URL courante:
            document.getElementById("ms_url_div").innerHTML=url;
        }
        
        // gestion de l'extension spatiale de la carte:
        // zoomin: true pour zoomer in
        // x coordonnée X du click dans l'image
        // y coordonnée Y du click dans l'image
        // retourne le nouvel extent (xmin ymin xmax ymax)
        function computeExtent(zoomin, x, y) {
            // parsing de l'extent pour extraire les coordonnées
            var coords = mapext.split(" ");
            width = coords[2] - coords[0];
            height = coords[3] - coords[1];
            
            // calcul de la nouvelle largeur et hauteur en fonction du zoom choisi.
            var factor = zoomin ? 0.5 : 2;
            width  *= factor;
            height *= factor;
            
            // transformation des coords image en coord terrain
            x = mouseXToMap(x);
            y = mouseYToMap(y);
            
            // calcul du nouvel extent
            mapext = "" + (x - (width/2)) + "+" + (x + (width/2)) + "+" + (y - (height/2)) + "+" + (y + (height/2));
            return mapext;
        }
        
        function mouseXToMap (x) {
            var imgsize = mapsize.split(" ");
            var coords = mapext.split(" ");
            width = coords[2] - coords[0];
            
            var ret = (parseFloat(coords[0]) + (x * (parseFloat(width))) / (parseFloat(imgsize[0]) - 1));
            return ret;        
        }
        
        function mouseYToMap (y) {
            var imgsize = mapsize.split(" ");
            var coords = mapext.split(" ");
            height = coords[3] - coords[1];
            
            var res = (parseFloat(coords[3]) + (y * (height)) / (1 - parseFloat(imgsize[1]))); 
            return res;
        }
        
        </script>

    </head>

    <body onload="refreshMap()">
        <h2>Page de test de Mapserver</h2>

        <h3>Carte Mapserver </h3>
        url:<div id="ms_url_div"></div>
        <br/>
        
        <!-- l'image affichant la carte MapServer: sa taille n'est pas précisée volontairement: ajustement automatique -->
        <img alt="Carte Mapserver" id="ms_image" src="" name="ms_image" onerror="imgError()" 
             onclick="clickImg(event)" style="border: 2px solid black;"/>

        <h3>Interaction avec Mapserver</h3>
        
        <!-- Le formulaire permettant d'interagir avec MapServer -->
        <form method="get" name="ms_form">
            <!-- elements de controle du zoom -->
            <label for="zoomin">Zoomin</label>
            <input type="radio" name="zoom" id="zoomin" checked="true"/> -
            <label for="zoomout">Zoomout</label>
            <input type="radio" name="zoom" id="zoomout"/>
            <br/>

            <textarea cols="50" rows="9" name="ms_commands">map.layer[lacs].class[0].style[0]=COLOR+151+51+151</textarea>
            <br/>
            <input type="button" value="Rafraichir la carte" name="ms_ok" onclick="refreshMap()">
                <hr/>
            
            <!-- DIV invisible affiché en cas d'erreur -->
                <div id="hid_div" style="visibility: hidden">
    
                Erreur Mapserver:<br/>
                    <textarea cols="75" rows="4" name="ms_erreur"></textarea>
                    <br/>
                    <iframe width="550" id="ms_frame" src="" style="border: 1px solid red;"/>
                    <br/>
                </div>
            </form>
        </body>
    </html>

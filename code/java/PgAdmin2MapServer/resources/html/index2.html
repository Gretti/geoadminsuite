<!DOCTYPE html>

<html>
    <head>
        <title>PgAdmin2MapServer 2</title>
        <link rel="icon" type="image/png" href="favicon.ico"/>
        <link rel="shortcut icon" href="favicon.ico"/>


        <link rel="stylesheet" type="text/css" href="mfbase/ext/resources/css/ext-all.css" />

        <script type="text/javascript" src="mfbase/openlayers/lib/OpenLayers.js"></script>

        <script type="text/javascript" src="mfbase/ext/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="mfbase/ext/ext-all-debug.js"></script>

        <script type="text/javascript">
            // Because of a bug in Firefox 2 we need to specify the MapFish base path.
            // See https://bugzilla.mozilla.org/show_bug.cgi?id=351282
            var gMfLocation = "mfbase/mapfish/";
        </script>
        <script type="text/javascript" src="mfbase/mapfish/MapFish.js"></script>

        <link rel="stylesheet" type="text/css" href="mfbase/mapfish/mapfish.css" />
        <style>
            .warningLayer {
                color: red;
            }
        </style>

        <script type="text/javascript"><!--
            
            
            var centered = false;
            // the default parameters
            var webSocket = null;
            var viewport = null;
            var treeModel = null;
            
            function showMessage( message, title ){
                Ext.Msg.show({
                    title: title,
                    msg: message,
                    buttons: Ext.MessageBox.OK,
                    icon: Ext.MessageBox.INFO
                });
            }            
            
            // adds new contextual plugins to layertree
            //Ext.getCmp('tree').
            // TODO: correct Firefox bug with this object.
            // see http://lists.mapfish.org/pipermail/users/2011-April/003259.html ?
            mapfish.widgets.LayerTree.MenuFeatures.test = function(layerTree, node, olLayers) {
                return {
                    text: "Style layer",
                    icon: "img/photo.png",
                    handler: function(menuItem, event) {
                        if (olLayers.length > 1) {
                            alert("More than one layer to style? ...");
                            return;
                        }
                        var lay = olLayers[0];
                        console.log("styling: " + lay.name);
                    }
                };
            }

            function createMap(config) {
                // first creates the layers
                var layers = createServerLayers(config);
                
                var extent = config.mapExtent.split(" ");
                var maxRes = (extent[2]-extent[0]) / 300; // todo: find the exact ratio.
                var srid = 4326;
                
                // TODO Manage SRS server side
                var proj = config.mapProjection == "epsg:0" ? "epsg:"+srid : new OpenLayers.Projection(config.mapProjection);
                var map = new OpenLayers.Map("map", 
                {
                    projection: proj,
                    maxExtent: new OpenLayers.Bounds(extent[0], extent[1], extent[2], extent[3]),
                    //maxResolution: 2400 //map units per pixel
                    maxResolution: maxRes
                });
                map.addControl(new OpenLayers.Control.MousePosition({
                    separator: ' | ',
                    numDigits: 5,
                    emptyString: 'Mouse is not over map.'
                }));
                map.events.register("mousemove", map, function(e) {
                    var position = this.events.getMousePosition(e);
                    OpenLayers.Util.getElement("coords").innerHTML = position;
                });
                map.addLayers(layers);
                console.log(map);
                return map;
            }
            
            /**
             * Creates OpenLayers layers from config object.
             * TODO: build layer logic on the server side
             */
            function createServerLayers(config) {
                var layArr = config.layers;
                var mapProjection = config.mapProjection;
                var ret = new Array();
                var baseLayer = new OpenLayers.Layer("Blank",{isBaseLayer: true});
                ret[ret.length] = baseLayer;                
            
                //TODO: change map projection test to put it before loop.
                
                for (var i = 0; i < layArr.length; i++) {
                    var ljson = layArr[i];
                    // layers bounds in projected coordinates
                    var e = ljson.extent.split(" ");
                    var bnds = new OpenLayers.Bounds(e[0], e[1], e[2], e[3])
                    // layers bounds in WGS coordinates
                    var ewgs = ljson.WGSExtent.split(" ");
                    var bndsWgs = new OpenLayers.Bounds(ewgs[0], ewgs[1], ewgs[2], ewgs[3])
                    var l = null;
                    
                    // if layers have mixed SRID (sameSRID property of the config object), set
                    // their wgs bounds as extent, else set their projected bounds
                    var layBounds = config.sameSRID ? bnds : bndsWgs;
                    
                    if (mapProjection == "epsg:0" || mapProjection == "epsg:-1") {
                        // build a MS layer if no projection provided
                        l = new OpenLayers.Layer.MapServer( ljson.name,
                        ljson.url, {
                            layers: ljson.name
                        }, {
                            singleTile: "true", 
                            opacity: 0.5,
                            isBaseLayer: false
                            // sets real layer bounds
                            ,maxExtent: bnds
                        });
                    } else {
                        l = new OpenLayers.Layer.WMS(ljson.name,
                        ljson.url, {
                            layers: ljson.name,
                            format: "image/png",
                            transparent: "true"
                        }, {
                            singleTile: true,
                            opacity: 0.5
                            ,maxExtent: layBounds
                        });
                    }
                    ret[ret.length] = l;    
                    //console.log('adding layer');
                    //console.log(l);
                }
                return ret;
            }

            function centerMap() {
                if (!centered) {
                    console.log("centering map...");
                    this.setCenter(new OpenLayers.LonLat(5,45), 6);
                    centered = true;
                }
            }

            function createToolbar(map) {
                return new mapfish.widgets.toolbar.Toolbar({map: map});
            }

            function initToolbarContent(toolbar) {
                function addSeparator(toolbar){
                    toolbar.add(new Ext.Toolbar.Spacer());
                    toolbar.add(new Ext.Toolbar.Separator());
                    toolbar.add(new Ext.Toolbar.Spacer());
                }

                toolbar.addControl(
                new OpenLayers.Control.ZoomToMaxExtent({map: map}), {
                    iconCls: "zoomfull",
                    toggleGroup: "map"
                }
            );
                addSeparator(toolbar);
                toolbar.addControl(
                new OpenLayers.Control.ZoomBox({isDefault: true}), {
                    iconCls: "zoomin",
                    toggleGroup: "map"
                }
            );
                toolbar.addControl(
                new OpenLayers.Control.ZoomBox({
                    out: true
                }), {
                    iconCls: "zoomout",
                    toggleGroup: "map"
                }
            );
                toolbar.addControl(
                new OpenLayers.Control.DragPan({
                    isDefault: false
                }), {
                    iconCls: "pan",
                    toggleGroup: "map"
                }
            );
                toolbar.activate();
            }
            
            /**
             * Ajax call to server to get map and layers setting
             * TODO: build tree in all cases, not in the success handler !!
             */
            function initMapLayers() {
                Ext.Ajax.request({
                    url: 'mapConfig?item=allLayers',
                    
                    success: function( response, options ){		
                        var jsonData = Ext.util.JSON.decode(response.responseText);
                        var map = createMap(jsonData);
                        var toolbar = createToolbar(map);
                        
                        viewport = new Ext.Viewport({
                            layout: "border",
                            listeners: {
                                //afterlayout: centerMap,
                                //scope: map
                            },
                            items: [{
                                    region: "west",
                                    id: "tools",
                                    //title: "Tools",
                                    border: false,
                                    width: 250,
                                    split: true,
                                    items: [{
                                            id: "tree",
                                            title: "PostGIS layers",
                                            xtype: "layertree",
                                            map: map,
                                            //height: "auto",
                                            height: 550,
                                            showWmsLegend: true,
                                            enableDD: true,
                                            model: jsonData.treeModel,
                                            plugins: [
                                                mapfish.widgets.LayerTree.createContextualMenuPlugin([
                                                    'zoomToExtent',
                                                    'opacitySlide',
                                                    'remove',
                                                    'test'
                                                ])
                                            ],
                                            collapsible: true
                                        }/*,{
                                            id: "shorcuts_container",
                                            title: "shorcuts",
                                            height: 50,
                                            items: [{
                                                    id: "shorcuts",
                                                    xtype: "panel",
                                                    height: 500,
                                                    html: "TODO: <br/>color layers, map extent, websocket"
                                                }]
                                        }*/]
                                }, {
                                    region: "center",
                                    id: "map",
                                    //title: "Map",
                                    layout: "fit",
                                    split: true,
                                    xtype: 'mapcomponent',
                                    map: map,
                                    tbar: toolbar
                                }, {
                                    region: "south",
                                    id: "search_grid",
                                    title: "Tasks",
                                    split: true,
                                    height: 150,
                                    contentEl: "taskDiv",
                                    collapsible: true
                                }]
                        });
                        
                        viewport.doLayout();
                        if (jsonData.layers.length == 0) {
                            showMessage("No PostGIS layer(s) found in the selected pgAdmin node.", "Database empty");
                        } else {
                            initToolbarContent(toolbar);
                            map.zoomToMaxExtent();                        
                        }
                    },
                    failure: function( response, options ){
                        var jsonData = Ext.util.JSON.decode(response.responseText);
                        showMessage(jsonData, "Error getting MapConfig" );
                    }
                });
            }
            
            
            Ext.onReady(function() {

                // parameters needed from server:
                // map extent, map projection
                // a list of layers with parameters:
                //  name, url, projection ?
                // createTreeModel with config option
                // text = objects name
                // icon according to type: collection position in json ?
                // if layer: name = layer name
                
                //createMapserverLayer(map);
                //var model = createTreeModelOriginal();
                initMapLayers();
                
                // opens the WebSocket channel to receive updates from server
                webSocket = new WebSocket('ws://localhost:8887/configDispatcher');
                
                webSocket.onopen = function(event) {
                    // just to test
                    var token = '{"type": "login", "username" : "user", "password" : "user"}';
                    //var lToken = {"type": "login", "ns": "org.jWebSocket.plugins.system", "username" : "user", "password" : "user"};
                    console.log('sending login token to socket server: ' + token);
                    webSocket.send(token);
                };
            
                webSocket.onmessage = function(event) { 
                    if (event.data.indexOf("{") == 0) {
                        // a json object as repsonse
                        // TODO: JSON framework here
                        console.log("server message: " + event.data);
                        var response = JSON.parse(event.data);

                        if (response.treeModel) {
                            // Force refresh the page :(
                            // time to find how to refresh the map
                            // with new MapConfig
                            window.location.href = "/map";
                            //
                            // server sends us a new mapConfig.
                            // Removes layers from map:
                            /*
                            var i = removeMapLayers();
                            console.log(i + " layer(s) removed");
                            // remove layers from layerTree
                            removeLayersFromTree();
                            
                            // refreshes the map
                            var map = createMap(response);

                            Ext.getCmp('map').map = map;
                            //refreshes the tree model
                            addLayersToTree(response.treeModel);
                            Ext.getCmp('tree').render();
                            viewport.doLayout();
                            console.log(map);
                            map.zoomToMaxExtent();
                            */
                        }
                    } else {
                        // a server message
                        console.log("server sent message: " + event.data);
                    }
                }
                
                
                // called when server closes this websocket
                webSocket.onclose = function(event) { 
                    console.log('server closed connection'); 
                }                
            });
            
            function removeLayersFromTree() {
                for (var i = 0; i < Ext.getCmp("tree").getRootNode().childNodes.length; i++) {
                    var n = Ext.getCmp("tree").getRootNode().childNodes[i];
                    console.log("removing node");
                    //console.log(n);
                    Ext.getCmp("tree").getRootNode().removeChild(n); 
                }
            }
            
            /**
             * Add given treeModel to the map layer tree:
             * TODO: find why mapfish contextual plugin is lost !
             */
            function addLayersToTree (treeModel) { 
                var t = Ext.getCmp("tree");
                for (var i = 0; i < treeModel.length; i++) {
                    t.getRootNode().appendChild(treeModel[i]);
                }
            }
            /**
             * Removes all layers from map.
             * @return the number of layers returned
             */               
            function removeMapLayers() {
                var cnt = 0;
                var m = Ext.getCmp('map').map;
                for (var i = 0; i < m.layers.length; i++) {
                    var l = m.layers[i];
                    
                    //if (!l.isBaseLayer) {
                    m.removeLayer(l);
                    cnt++;
                    //}
                }
                return cnt;
            }
            
        </script>

        <style type="text/css">
            .zoomin {
                background-image:url(mfbase/mapfish/img/icon_zoomin.png) !important;
                height:20px !important;
                width:20px !important;
            }
            .zoomout {
                background-image:url(mfbase/mapfish/img/icon_zoomout.png) !important;
                height:20px !important;
                width:20px !important;
            }
            .zoomfull {
                background-image:url(mfbase/mapfish/img/icon_zoomfull.png) !important;
                height:20px !important;
                width:20px !important;
            }
            .pan {
                background-image:url(mfbase/mapfish/img/icon_pan.png) !important;
                height:20px !important;
                width:20px !important;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>
        <div id="coords" style="height: 1.5em;"></div>
        <div id="taskDiv">
            TODO: base styling: layer colors, line width, symbols. Setting layer extent.  Distinct colors for layers (color ramp to define).<br/>
            postgis raster support to test. Pure geoJSON client for PG 9.2. 
            File D'N'D support (geo, images, etc.)<br/>
            Packaging for all plateforms.
        </div>
    </body>
</html>

